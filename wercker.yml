box: pei0804/go-node-docker
build:
  after-steps:
      - slack-notifier:
          url: $SLACK_WEBHOOK_URL
          channel: notification
          username: github
  steps:
  - script:
      name: ソースの場所を保存する
      code: |-
        : ${SERVER:="./go/src/app"}
        : ${CLIENT:="./client"}
  - script:
      name: client install
      cwd: ${CLIENT}
      code: |
        npm install -g webpack
  - script:
      name: client versionをチェックする
      code: |
        node -v
        npm -v
        yarn -v
  - script:
      name: client install build
      cwd: ${CLIENT}
      code: |
        yarn --ignore-optional
        NODE_PATH=$(which node) REPO=app yarn build
  - script:
      name: client lint
      cwd: ${CLIENT}
      code: |
        make lint
  - script:
      name: backend versionをチェックする
      code: |
        go version
  - script:
      name: backend install command
      cwd: ${SERVER}
      code: |
        go get -u github.com/golang/dep/...
        go get -u github.com/alecthomas/gometalinter/...
        gometalinter --install --update --force
  - script:
      name: backend set env
      code: |
        export GOPATH="$(pwd)/go:$WERCKER_SOURCE_DIR"
        export repo="app"
        export Op="production"
  - script:
      cwd: ${SERVER}
      name: backend depで依存パッケージをインストールする
      code: |
        dep ensure
        dep status
  - script:
      cwd: ${SERVER}
      name: backend goagenでコード生成する
      code: |
        (cd vendor/github.com/goadesign/goa/goagen && GOROOT=/usr/local/go go get && GOROOT=/usr/local/go go build)
        ./vendor/github.com/goadesign/goa/goagen/goagen version
        ./vendor/github.com/goadesign/goa/goagen/goagen app -d ${repo}/design
        ./vendor/github.com/goadesign/goa/goagen/goagen client -d ${repo}/design
        ./vendor/github.com/goadesign/goa/goagen/goagen swagger -d ${repo}/design -o server
  - script:
      cwd: ${SERVER}
      name: backend lint
      code: |
        make lint
  - script:
      cwd: ${SERVER}
      name: backend go build
      code: |
        make build
