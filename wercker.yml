box: pei0804/gae-go-deploy
build:
  after-steps:
      - slack-notifier:
          url: $SLACK_WEBHOOK_URL
          channel: notification
          username: github
  steps:
  - script:
      name: ソースの場所を保存する
      code: |-
        : ${SERVER:="./go/src/app"}
        : ${CLIENT:="./client"}
        : ${GAE:="./gae"}
  - script:
      name: client install
      cwd: ${CLIENT}
      code: |
        npm install -g yarn webpack
  - script:
      name: client versionをチェックする
      code: |
        node -v
        npm -v
        yarn -v
  - script:
      name: client install build
      cwd: ${CLIENT}
      code: |
        yarn --ignore-optional
        NODE_PATH=$(which node) REPO=app yarn build
  - script:
      name: client lint
      cwd: ${CLIENT}
      code: |
        ./node_modules/.bin/eslint src
  - script:
      name: backend GOROOTのパッケージに一般ユーザーからの書き込みの許可
      code: |
        sudo chmod -R a+w `goapp env GOROOT`/pkg
  - script:
      name: backend versionをチェックする
      code: |
        goapp version
        go version
  - script:
      name: backend install command
      code: |
        GOROOT=/usr/local/go go get -u github.com/golang/dep/...
        GOROOT=/usr/local/go go get -u github.com/alecthomas/gometalinter/...
        gometalinter --install --update --force
  - script:
      name: backend set env
      code: |
        export GOPATH="$(pwd)/go:$WERCKER_SOURCE_DIR"
        goapp env GOPATH
        export repo="app"
        export Op="production"
  - script:
      cwd: ${SERVER}
      name: backend depで依存パッケージをインストールする
      code: |
        dep ensure
        dep status
  - script:
      name: backend check command
      code: |
        ls /usr/local/go_appengine/gopath/bin
  - script:
      cwd: ${SERVER}
      name: backend goagenでコード生成する
      code: |
        (cd vendor/github.com/goadesign/goa/goagen && GOROOT=/usr/local/go go get && GOROOT=/usr/local/go go build)
        ./vendor/github.com/goadesign/goa/goagen/goagen version
        ./vendor/github.com/goadesign/goa/goagen/goagen app -d ${repo}/design
        ./vendor/github.com/goadesign/goa/goagen/goagen client -d ${repo}/design
        ./vendor/github.com/goadesign/goa/goagen/goagen swagger -d ${repo}/design -o server
  - script:
      cwd: ${SERVER}
      name: backend lint
      code: |
        gometalinter ./... --config=lint_config.json
  - script:
      name: backend envを本番用のものを設定する
      code: |
        cp -f ${SERVER}/server/env.yaml.production ${SERVER}/server/env.yaml
  - script:
      cwd: ${SERVER}/server
      name: backend goapp build
      code: |
        goapp build
  - script:
      cwd: ${SERVER}
      name: backend goapp test
      code: |
        goapp test .
  - script:
      cwd: ${SERVER}
      name: backend コードを$WERCKER_OUTPUT_DIRへ
      code: |-
        rsync -avz ${GOPATH%%:*}/ $WERCKER_OUTPUT_DIR
deploy:
  steps:
  - script:
      name: set env(deployツールの仕様対応)
      code: |
        export WERCKER_GIT_DOMAIN=""
        export WERCKER_GIT_OWNER=""
        export WERCKER_GIT_REPOSITORY="app"
  - script:
      name: check env
      code: |
        env
  - script:
    name: deploy info
    code: find .
  - michilu/go-appengine-deploy:
    token: $APP_ENGINE_TOKEN
